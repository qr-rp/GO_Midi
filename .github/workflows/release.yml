name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  WX_VERSION: "3.3.1"

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-make mingw-w64-x86_64-pkg-config
    
    - name: Cache wxWidgets
      id: cache-wx
      uses: actions/cache@v4
      with:
        path: D:\wxWidgets-install
        key: wxwidgets-${{ env.WX_VERSION }}-mingw64-v2
    
    - name: Download and Build wxWidgets
      if: steps.cache-wx.outputs.cache-hit != 'true'
      shell: msys2 {0}
      run: |
        cd /d
        curl -L -o wxWidgets.tar.bz2 "https://github.com/wxWidgets/wxWidgets/releases/download/v${WX_VERSION}/wxWidgets-${WX_VERSION}.tar.bz2"
        tar -xjf wxWidgets.tar.bz2
        ls -la
        cd wxWidgets-${WX_VERSION}
        mkdir -p build-static && cd build-static
        ../configure --prefix=/d/wxWidgets-install --disable-debug --enable-static --disable-shared --without-libtiff --without-libjpeg --without-libpng
        make -j$(nproc)
        make install
    
    - name: Build Application
      shell: msys2 {0}
      run: |
        rm -rf build || true
        mkdir build
        cd build
        cmake .. -G "MinGW Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DwxWidgets_ROOT_DIR=/d/wxWidgets-install \
          -DwxWidgets_LIB_DIR=/d/wxWidgets-install/lib \
          -DUSE_STATIC_WX=ON
        mingw32-make -j$(nproc)
    
    - name: Create archive
      run: |
        mkdir -p release
        cp build/GO_MIDI!.exe release/
        cd release
        7z a -tzip ../GO_MIDI-Windows.zip .
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: GO_MIDI-Windows.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
