name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  WX_VERSION: "3.3.1"

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Cache wxWidgets
      id: cache-wx
      uses: actions/cache@v4
      with:
        path: D:\wxWidgets-install
        key: wxwidgets-${{ env.WX_VERSION }}-msvc-v1
    
    - name: Download and Build wxWidgets
      if: steps.cache-wx.outputs.cache-hit != 'true'
      run: |
        cd D:\
        curl -L -o wxWidgets.tar.bz2 "https://github.com/wxWidgets/wxWidgets/releases/download/v${{ env.WX_VERSION }}/wxWidgets-${{ env.WX_VERSION }}.tar.bz2"
        7z x wxWidgets.tar.bz2 -y
        7z x wxWidgets.tar -o"D:\wxWidgets-${{ env.WX_VERSION }}" -y
        cd D:\wxWidgets-${{ env.WX_VERSION }}\build\msw
        msbuild wx_vc17.sln /m /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143
    
    - name: Build Application
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DwxWidgets_ROOT_DIR="D:\wxWidgets-${{ env.WX_VERSION }}" `
          -DwxWidgets_LIB_DIR="D:\wxWidgets-${{ env.WX_VERSION }}\lib\vc_x64_lib"
        cmake --build . --config Release
    
    - name: Create archive
      run: |
        mkdir release
        copy build\Release\GO_MIDI!.exe release\
        cd release
        7z a -tzip ..\GO_MIDI-Windows.zip .
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: GO_MIDI-Windows.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}